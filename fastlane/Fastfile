fastlane_version "2.54.4"

default_platform :ios

before_all do
  #ensure_git_status_clean
end

lane :cleanup do |options|
  artifacts = []
  # TODO Add IONIC env variables when implemented
  artifacts << ENV['CORDOVA_IOS_RELEASE_BUILD_PATH'] if ENV['CORDOVA_IOS_RELEASE_BUILD_PATH']
  artifacts << ENV['CORDOVA_ANDROID_RELEASE_BUILD_PATH'] if ENV['CORDOVA_ANDROID_RELEASE_BUILD_PATH']
  artifacts << lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH] if lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
  artifacts << lane_context[SharedValues::IPA_OUTPUT_PATH] if lane_context[SharedValues::IPA_OUTPUT_PATH]
  UI.verbose(artifacts)
  copy_artifacts(
    target_path: "artifacts/" + lane_context[SharedValues::LANE_NAME],
    artifacts: artifacts,
    keep_original: false
  )

  # Reset the git repo to a clean state, but leave our artifacts in place
  #reset_git_repo(
  #  exclude: ['artifacts', 'node_modules', 'platforms', 'plugins', 'www'] #,
    #skip_clean: true
  #)
end

platform :ios do
  before_all do
    # ENV["SLACK_URL"] = "https://hooks.slack.com/services/..."
  end

  lane :upgrade_xcode do
    team_id = CredentialsManager::AppfileConfig.try_fetch_value(:team_id)
    xcodeprojpath = "platforms/ios/FastlaneExample.xcodeproj"
    upgrade_super_old_xcode_project(
      path: xcodeprojpath,
      team_id: team_id,
      use_automatic_signing: true
    )
  end

  desc "Build Debug Debug Ionic"
  lane :build_debug_debug_ionic do
    ionic(
      platform: 'ios',
      prod: false,
      release: false,
      type: 'development'
    )
    cleanup
  end

  desc "Build Debug Ionic"
  lane :build_debug_ionic do
    ionic(
      platform: 'ios',
      prod: true,
      release: false,
      type: 'development'
    )
    cleanup
  end

  desc "Build Debug Cordova"
  lane :build_debug_cordova do
    cordova(
      platform: 'ios',
      release: false,
      type: 'development'
    )
    cleanup
  end

  desc "Build Debug Native"
  lane :build_debug_native do
    match
    name = "FastlaneExample" # TODO Extract
    #team_id = CredentialsManager::AppfileConfig.try_fetch_value(:team_id)
    #xcprojpath = "platforms/ios/" + name + ".xcodeproj" # TODO Extract
    #enable_automatic_code_signing(
    #  team_id: team_id,
    #  path: xcprojpath
    #)
    xcworkspacepath = "platforms/ios/" + name + ".xcworkspace" # TODO Extract
    gym(
      configuration: 'Debug',
      workspace: xcworkspacepath,
      scheme: name,
      export_method: 'development'
    )
    cleanup
  end

  desc "Submit a new Beta Build to Apple TestFlight"
  desc "This will also make sure the profile is up to date"
  lane :beta do
    # match(type: "appstore") # more information: https://codesigning.guide
    gym # Build your app - more options available
    pilot

    # sh "your_script.sh"
    # You can also use other beta testing services here (run `fastlane actions`)
  end

  desc "Build Release Ionic"
  lane :build_release_ionic do
    match(type: 'appstore')
    ionic(
      platform: 'ios',
      prod: true,
      release: true
    )
    cleanup
  end

  desc "Build Release Cordova"
  lane :build_release_cordova do
    match(type: 'appstore')
    cordova(
      platform: 'ios',
      release: true
    )
    cleanup
  end

  desc "Build Release Native"
  lane :build_release_native do
    match(type: 'appstore')
    name = "FastlaneExample" # TODO Extract
    xcworkspacepath = "platforms/ios/" + name + ".xcworkspace" # TODO Extract
    gym(
      configuration: 'Release',
      workspace: xcworkspacepath,
      scheme: name,
      codesigning_identity: 'iPhone Developer'
    )
    cleanup
  end

  desc "Deploy a new version to the App Store"
  lane :release do
    # match(type: "appstore")
    # snapshot
    gym # Build your app - more options available
    deliver(force: true)
    # frameit
  end

  # You can define as many lanes as you want

  after_all do |lane|
    # This block is called, only if the executed lane was successful

    # slack(
    #   message: "Successfully deployed new App Update."
    # )
  end

  error do |lane, exception|
    # slack(
    #   message: exception.message,
    #   success: false
    # )
  end
end

platform :android do
  before_all do
    # ENV["SLACK_URL"] = "https://hooks.slack.com/services/..."
  end

  desc "Build Debug Debug Ionic"
  lane :build_debug_debug_ionic do
    ionic(
      platform: 'android',
      release: false,
      prod: false
    )
    cleanup
  end

  desc "Build Debug Ionic"
  lane :build_debug_ionic do
    ionic(
      platform: 'android',
      release: false,
      prod: true
    )
    cleanup
  end

  desc "Build Debug Cordova"
  lane :build_debug_cordova do
    cordova(
      platform: 'android',
      release: false
    )
    cleanup
  end

  desc "Build Debug Native"
  lane :build_debug_native do
    gradle(
      task: 'assemble',
      build_type: 'Debug',
      project_dir: 'platforms/android'
    )
    cleanup
  end

  desc "Submit a new Beta Build to Crashlytics Beta"
  lane :beta do
    gradle(task: "assembleRelease")
    crashlytics

    # sh "your_script.sh"
    # You can also use other beta testing services here
  end

  desc "Build Release Ionic"
  lane :build_release_ionic do
    ionic(
      platform: 'android',
      release: true,
      prod: true,

      keystore_path: '../Dropbox/zaehlerstand.keystore',
      keystore_alias: 'Zaehlerstand',
      keystore_password: ENV["KEYSTORE_PASSWORD"],
      key_password: ENV["KEYSTORE_PASSWORD"]
    )
    cleanup
  end

  desc "Build Release Cordova"
  lane :build_release_cordova do
    cordova(
      platform: 'android',
      release: true,

      keystore_path: '../Dropbox/Zaehlerstand.keystore',
      keystore_alias: 'Zaehlerstand',
      keystore_password: ENV["KEYSTORE_PASSWORD"],
      key_password: ENV["KEYSTORE_PASSWORD"]
    )
    cleanup
  end

  desc "Build Release Native"
  lane :build_release_native do
    gradle(
      task: 'assemble',
      build_type: 'Release',
      project_dir: 'platforms/android',

      properties: {
        "android.injected.signing.store.file" => "../Dropbox/Zaehlerstand.keystore",
        "android.injected.signing.store.password" => ENV["KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => "Zaehlerstand",
        "android.injected.signing.key.password" => ENV["KEYSTORE_PASSWORD"],
      }
    )
    cleanup
  end

  desc "Deploy a new version to the Google Play"
  lane :deploy do
    gradle(task: "assembleRelease")
    supply
  end

  # You can define as many lanes as you want

  after_all do |lane|
    # This block is called, only if the executed lane was successful

    # slack(
    #   message: "Successfully deployed new App Update."
    # )
  end

  error do |lane, exception|
    # slack(
    #   message: exception.message,
    #   success: false
    # )
  end
end
